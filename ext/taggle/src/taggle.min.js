/* !
 * @author Sean Coker <sean@seancoker.com>
 * @version 1.6.1
 * @url http://sean.is/poppin/tags
 * @license MIT
 * @description Taggle is a dependency-less tagging library
 */
!function(t,e){"use strict"
function s(e,s){var i=""
if(t.getComputedStyle)i=getComputedStyle(e).getPropertyValue(s)
else if(e.currentStyle)try{i=e.currentStyle[s]}catch(n){}return i}function i(){for(var t=arguments[0],e=1,s=arguments.length;s>e;e++){var i=arguments[e]
for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])}return t}function n(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)}function a(t,e,s){t.addEventListener?t.addEventListener(e,s,!1):t.attachEvent?t.attachEvent("on"+e,s):t["on"+e]=s}function r(t){return t.replace(/^\s+|\s+$/g,"")}function o(e,s){t.attachEvent&&!t.addEventListener?e.innerText=s:e.textContent=s}var l=function(){},h={additionalTagClasses:"",allowDuplicates:!1,saveOnBlur:!1,duplicateTagClass:"",containerFocusClass:"active",hiddenInputName:"taggles[]",tags:[],allowedTags:[],disallowedTags:[],tabIndex:1,placeholder:"Enter tags...",submitKeys:[],preserveCase:!1,tagFormatter:l,onBeforeTagAdd:l,onTagAdd:l,onBeforeTagRemove:l,onTagRemove:l},u=8,p=188,c=9,g=13,d=function(t,s){this.settings=i({},h,s),this.measurements={container:{rect:null,style:null,padding:null}},this.container=t,this.tag={values:[],elements:[]},this.list=e.createElement("ul"),this.inputLi=e.createElement("li"),this.input=e.createElement("input"),this.sizer=e.createElement("div"),this.pasting=!1,this.placeholder=null,this.settings.placeholder&&(this.placeholder=e.createElement("span")),this.settings.submitKeys.length||(this.settings.submitKeys=[p,c,g]),"string"==typeof t&&(this.container=e.getElementById(t)),this._getMeasurements(),this._setupTextarea(),this._attachEvents()}
d.prototype._getMeasurements=function(){var e,s,i
this.measurements.container.rect=this.container.getBoundingClientRect(),this.measurements.container.style=t.getComputedStyle(this.container),e=this.measurements.container.style,s=parseInt(e["padding-left"]||e.paddingLeft,10),i=parseInt(e["padding-right"]||e.paddingRight,10),this.measurements.container.padding=s+i},d.prototype._setupTextarea=function(){var e,i=s(this.container,"position")
if(console.warn("Pos:",i),-1===["relative","absolute","fixed"].indexOf(i)&&(this.container.style.position="relative"),this.list.className="taggle_list",this.input.type="text",this.input.className="taggle_input",this.input.tabIndex=this.settings.tabIndex,this.sizer.className="taggle_sizer",this.settings.tags.length)for(var n=0,a=this.settings.tags.length;a>n;n++){var r=this._createTag(this.settings.tags[n])
this.list.appendChild(r)}this.placeholder&&(this.placeholder.style.opacity=0,this.placeholder.classList.add("taggle_placeholder"),this.container.appendChild(this.placeholder),o(this.placeholder,this.settings.placeholder),this.settings.tags.length||(this.placeholder.style.opacity=1)),this.inputLi.appendChild(this.input),this.list.appendChild(this.inputLi),this.container.appendChild(this.list),this.container.appendChild(this.sizer),e=t.getComputedStyle(this.input).fontSize,this.sizer.style.fontSize=e},d.prototype._attachEvents=function(){var t=this
a(this.container,"click",function(){t.input.focus()}),a(this.input,"focus",this._focusInput.bind(this)),a(this.input,"blur",this._blurEvent.bind(this)),a(this.input,"keydown",this._keydownEvents.bind(this)),a(this.input,"keyup",this._keyupEvents.bind(this))},d.prototype._fixInputWidth=function(){var t,e,s,i,n
this._setInputWidth(),e=this.input.getBoundingClientRect(),s=this.measurements.container.rect,t=~~s.width,t||(t=~~s.right-~~s.left),i=~~e.left-~~s.left,n=this.measurements.container.padding,this._setInputWidth(t-i-n)},d.prototype._canAdd=function(t,e){if(!e)return!1
if(this.settings.onBeforeTagAdd(t,e)===!1)return!1
if(!this.settings.allowDuplicates&&this._hasDupes(e))return!1
var s=this.settings.preserveCase,i=this.settings.allowedTags
if(i.length&&!this._tagIsInArray(e,i,s))return!1
var n=this.settings.disallowedTags
return n.length&&this._tagIsInArray(e,n,s)?!1:!0},d.prototype._tagIsInArray=function(t,e,s){if(s)return-1!==e.indexOf(t)
var i=[].slice.apply(e).map(function(t){return t.toLowerCase()})
return-1!==i.indexOf(t)},d.prototype._add=function(t,e){var s=this,i=e||""
"string"!=typeof e&&(i=r(this.input.value)),i.split(",").map(function(t){return s._formatTag(t)}).forEach(function(e){if(s._canAdd(t,e)){var i=s._createTag(e),n=s.list.querySelectorAll("li"),a=n[n.length-1]
s.list.insertBefore(i,a),s.settings.onTagAdd(t,e),s.input.value="",s._setInputWidth(),s._fixInputWidth(),s._focusInput()}})},d.prototype._checkLastTag=function(e){e=e||t.event
var s=this.container.querySelectorAll(".taggle"),i=s[s.length-1],n="taggle_hot",a=this.input.classList.contains("taggle_back")
""!==this.input.value||e.keyCode!==u||a?i.classList.contains(n)&&i.classList.remove(n):i.classList.contains(n)?(this.input.classList.add("taggle_back"),this._remove(i,e),this._fixInputWidth(),this._focusInput()):i.classList.add(n)},d.prototype._setInputWidth=function(t){this.input.style.width=(t||10)+"px"},d.prototype._hasDupes=function(t){var e,s=this.tag.values.indexOf(t),i=this.container.querySelector(".taggle_list")
if(this.settings.duplicateTagClass){e=i.querySelectorAll("."+this.settings.duplicateTagClass)
for(var n=0,a=e.length;a>n;n++)e[n].classList.remove(this.settings.duplicateTagClass)}return s>-1?(this.settings.duplicateTagClass&&i.childNodes[s].classList.add(this.settings.duplicateTagClass),!0):!1},d.prototype._isConfirmKey=function(t){var e=!1
return this.settings.submitKeys.indexOf(t)>-1&&(e=!0),e},d.prototype._focusInput=function(){this._fixInputWidth(),this.container.classList.contains(this.settings.containerFocusClass)||this.container.classList.add(this.settings.containerFocusClass),this.placeholder&&(this.placeholder.style.opacity=0)},d.prototype._blurEvent=function(e){if(this.settings.saveOnBlur){if(e=e||t.event,this._listenForEndOfContainer(),""!==this.input.value)return void this._confirmValidTagEvent(e)
this.tag.values.length&&this._checkLastTag(e)}else this.input.value="",this._setInputWidth(),this.container.classList.contains(this.settings.containerFocusClass)&&this.container.classList.remove(this.settings.containerFocusClass),!this.tag.values.length&&this.placeholder&&(this.placeholder.style.opacity=1)},d.prototype._keydownEvents=function(e){e=e||t.event
var s=e.keyCode
return this.pasting=!1,this._listenForEndOfContainer(),86===s&&e.metaKey&&(this.pasting=!0),this._isConfirmKey(s)&&""!==this.input.value?void this._confirmValidTagEvent(e):void(this.tag.values.length&&this._checkLastTag(e))},d.prototype._keyupEvents=function(e){e=e||t.event,this.input.classList.remove("taggle_back"),o(this.sizer,this.input.value),this.pasting&&""!==this.input.value&&(this._add(e),this.pasting=!1)},d.prototype._confirmValidTagEvent=function(e){e=e||t.event,e.preventDefault?e.preventDefault():e.returnValue=!1,this._add(e)},d.prototype._listenForEndOfContainer=function(){var t=this.sizer.getBoundingClientRect().width,e=this.measurements.container.rect.width-this.measurements.container.padding,s=parseInt(this.sizer.style.fontSize,10)
t+1.5*s>parseInt(this.input.style.width,10)&&(this.input.style.width=e+"px")},d.prototype._createTag=function(t){var s=e.createElement("li"),i=e.createElement("button"),n=e.createElement("input"),r=e.createElement("span")
t=this._formatTag(t),i.innerHTML="&times;",i.className="close",a(i,"click",this._remove.bind(this,i)),o(r,t),r.className="taggle_text",s.className="taggle "+this.settings.additionalTagClasses,n.type="hidden",n.value=t,n.name=this.settings.hiddenInputName,s.appendChild(r),s.appendChild(i),s.appendChild(n)
var l=this.settings.tagFormatter(s)
if("undefined"!=typeof l&&(s=l),!(s instanceof HTMLElement)||"LI"!==s.tagName)throw new Error("tagFormatter must return an li element")
return this.tag.values.push(t),this.tag.elements.push(s),s},d.prototype._remove=function(t,e){var s,i,n,a
"li"!==t.tagName.toLowerCase()&&(t=t.parentNode),s=t.querySelector(".taggle_text"),i=s.innerText||s.textContent,this.settings.onBeforeTagRemove(e,i)!==!1&&(t.parentNode.removeChild(t),n="a"===t.tagName.toLowerCase()?t.parentNode:t,a=this.tag.elements.indexOf(n),this.tag.elements.splice(a,1),this.tag.values.splice(a,1),this.settings.onTagRemove(e,i),this._focusInput())},d.prototype._formatTag=function(t){return this.settings.preserveCase?t:t.toLowerCase()},d.prototype.getTags=function(){return{elements:this.getTagElements(),values:this.getTagValues()}},d.prototype.getTagElements=function(){return this.tag.elements},d.prototype.getTagValues=function(){return[].slice.apply(this.tag.values)},d.prototype.getInput=function(){return this.input},d.prototype.getContainer=function(){return this.container},d.prototype.add=function(t){var e=n(t)
if(e)for(var s=0,i=t.length;i>s;s++)"string"==typeof t[s]&&this._add(null,t[s])
else this._add(null,t)
return this},d.prototype.remove=function(t,e){for(var s=this.tag.values.length-1,i=!1;s>-1&&(this.tag.values[s]===t&&(i=!0,this._remove(this.tag.elements[s])),!i||e);)s--
return this},d.prototype.removeAll=function(){for(var t=this.tag.values.length-1;t>=0;t--)this._remove(this.tag.elements[t])
return this},"function"==typeof define&&define.amd?define([],function(){return d}):"object"==typeof exports?module.exports=d:t.Taggle=d}(window,document)
