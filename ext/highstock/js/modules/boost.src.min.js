/**
 * This is an experimental Highcharts module that draws long data series on a canvas
 * in order to increase performance of the initial load time and tooltip responsiveness.
 *
 * Compatible with HTML5 canvas compatible browsers (not IE < 9).
 *
 * Author: Torstein Honsi
 *
 * 
 * Development plan
 * - Column range.
 * - Heatmap.
 * - Treemap.
 * - Check how it works with Highstock and data grouping.
 * - Check inverted charts.
 * - Check reversed axes.
 * - Chart callback should be async after last series is drawn. (But not necessarily, we don't do
     that with initial series animation).
 * - Cache full-size image so we don't have to redraw on hide/show and zoom up. But k-d-tree still
 *   needs to be built.
 * - Test IE9 and IE10.
 * - Stacking is not perhaps not correct since it doesn't use the translation given in 
 *   the translate method. If this gets to complicated, a possible way out would be to 
 *   have a simplified renderCanvas method that simply draws the areaPath on a canvas.
 *
 * If this module is taken in as part of the core
 * - All the loading logic should be merged with core. Update styles in the core.
 * - Most of the method wraps should probably be added directly in parent methods.
 *
 * Notes for boost mode
 * - Area lines are not drawn
 * - Point markers are not drawn
 * - Zones and negativeColor don't work
 * - Columns are always one pixel wide. Don't set the threshold too low.
 *
 * Optimizing tips for users
 * - For scatter plots, use a marker.radius of 1 or less. It results in a rectangle being drawn, which is 
 *   considerably faster than a circle.
 * - Set extremes (min, max) explicitly on the axes in order for Highcharts to avoid computing extremes.
 * - Set enableMouseTracking to false on the series to improve total rendering time.
 * - The default threshold is set based on one series. If you have multiple, dense series, the combined
 *   number of points drawn gets higher, and you may want to set the threshold lower in order to 
 *   use optimizations.
 */
!function(t){"object"==typeof module&&module.exports?module.exports=t:t(Highcharts)}(function(t){"use strict"
function e(t,i,o,n,r){r=r||0,n=n||y,l(t.slice(r,r+n),i),r+n<t.length?setTimeout(function(){e(t,i,o,n,r+n)}):o&&o()}var i=t.win,o=i.document,n=function(){},r=t.Color,a=t.Series,s=t.seriesTypes,l=t.each,c=t.extend,p=t.addEvent,h=t.fireEvent,d=t.merge,u=t.pick,g=t.wrap,m=t.getOptions().plotOptions,y=5e4
l(["area","arearange","column","line","scatter"],function(t){m[t]&&(m[t].boostThreshold=5e3)}),l(["translate","generatePoints","drawTracker","drawPoints","render"],function(t){function e(e){var i=this.options.stacking&&("translate"===t||"generatePoints"===t);(this.processedXData||this.options.data).length<(this.options.boostThreshold||Number.MAX_VALUE)||i?("render"===t&&this.image&&(this.image.attr({href:""}),this.animate=null),e.call(this)):this[t+"Canvas"]&&this[t+"Canvas"]()}g(a.prototype,t,e),"translate"===t&&(s.column&&g(s.column.prototype,t,e),s.arearange&&g(s.arearange.prototype,t,e))}),g(a.prototype,"getExtremes",function(t){this.hasExtremes()||t.apply(this,Array.prototype.slice.call(arguments,1))}),g(a.prototype,"setData",function(t){this.hasExtremes(!0)||t.apply(this,Array.prototype.slice.call(arguments,1))}),g(a.prototype,"processData",function(t){this.hasExtremes(!0)||t.apply(this,Array.prototype.slice.call(arguments,1))}),t.extend(a.prototype,{pointRange:0,hasExtremes:function(t){var e=this.options,i=e.data,o=this.xAxis&&this.xAxis.options,n=this.yAxis&&this.yAxis.options
return i.length>(e.boostThreshold||Number.MAX_VALUE)&&"number"==typeof n.min&&"number"==typeof n.max&&(!t||"number"==typeof o.min&&"number"==typeof o.max)},destroyGraphics:function(){var t,e,i=this,o=this.points
if(o)for(e=0;e<o.length;e+=1)t=o[e],t&&t.graphic&&(t.graphic=t.graphic.destroy())
l(["graph","area","tracker"],function(t){i[t]&&(i[t]=i[t].destroy())})},getContext:function(){var t=this.chart,e=t.plotWidth,i=t.plotHeight,n=this.ctx,r=function(t,e,i,o,n,r,a){t.call(this,i,e,o,n,r,a)}
return this.canvas?n.clearRect(0,0,e,i):(this.canvas=o.createElement("canvas"),this.image=t.renderer.image("",0,0,e,i).add(this.group),this.ctx=n=this.canvas.getContext("2d"),t.inverted&&l(["moveTo","lineTo","rect","arc"],function(t){g(n,t,r)})),this.canvas.setAttribute("width",e),this.canvas.setAttribute("height",i),this.image.attr({width:e,height:i}),n},canvasToSVG:function(){this.image.attr({href:this.canvas.toDataURL("image/png")})},cvsLineTo:function(t,e,i){t.lineTo(e,i)},renderCanvas:function(){var t,i,o,a,s,l,g,m,f,v,x=this,T=x.options,b=x.chart,k=this.xAxis,w=this.yAxis,A=0,S=x.processedXData,C=x.processedYData,D=T.data,M=k.getExtremes(),P=M.min,X=M.max,E=w.getExtremes(),G=E.min,L=E.max,Y={},N=!!x.sampling,O=T.marker&&T.marker.radius,V=this.cvsDrawPoint,R=T.lineWidth?this.cvsLineTo:!1,U=1>=O?this.cvsMarkerSquare:this.cvsMarkerCircle,W=T.enableMouseTracking!==!1,q=T.threshold,K=w.getThreshold(q),_="number"==typeof q,j=K,B=this.fill,H=x.pointArrayMap&&"low,high"===x.pointArrayMap.join(","),I=!!T.stacking,z=x.cropStart||0,F=b.options.loading,J=x.requireSorting,Q=T.connectNulls,Z=!S,$=x.fillOpacity?new r(x.color).setOpacity(u(T.fillOpacity,.75)).get():x.color,tt=function(){B?(t.fillStyle=$,t.fill()):(t.strokeStyle=x.color,t.lineWidth=T.lineWidth,t.stroke())},et=function(e,i,o){0===A&&t.beginPath(),l?t.moveTo(e,i):V?V(t,e,i,o,s):R?R(t,e,i):U&&U(t,e,i,O),A+=1,1e3===A&&(tt(),A=0),s={clientX:e,plotY:i,yBottom:o}},it=function(t,e,i){W&&!Y[t+","+e]&&(Y[t+","+e]=!0,b.inverted&&(t=k.len-t,e=w.len-e),a.push({clientX:t,plotX:t,plotY:e,i:z+i}))};(this.points||this.graph)&&this.destroyGraphics(),x.plotGroup("group","series",x.visible?"visible":"hidden",T.zIndex,b.seriesGroup),x.getAttribs(),x.markerGroup=x.group,p(x,"destroy",function(){x.markerGroup=null}),a=this.points=[],t=this.getContext(),x.buildKDTree=n,D.length>99999&&(b.options.loading=d(F,{labelStyle:{backgroundColor:"rgba(255,255,255,0.75)",padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),b.showLoading("Drawing..."),b.options.loading=F,b.loadingShown===!0?b.loadingShown=1:b.loadingShown=b.loadingShown+1),i=0,e(I?x.data:S||D,function(t){var e,n,r,a,s,c,p=!0
Z?(e=t[0],n=t[1]):(e=t,n=C[i]),H?(Z&&(n=t.slice(1,3)),c=n[0],n=n[1]):I&&(e=t.x,n=t.stackY,c=n-t.y),s=null===n,J||(p=n>=G&&L>=n),!s&&e>=P&&X>=e&&p&&(r=Math.round(k.toPixels(e,!0)),N?((void 0===f||r===o)&&(H||(c=n),(void 0===v||n>m)&&(m=n,v=i),(void 0===f||g>c)&&(g=c,f=i)),r!==o&&(void 0!==f&&(a=w.toPixels(m,!0),K=w.toPixels(g,!0),et(r,_?Math.min(a,j):a,_?Math.max(K,j):K),it(r,a,v),K!==a&&it(r,K,f)),f=v=void 0,o=r)):(a=Math.round(w.toPixels(n,!0)),et(r,a,K),it(r,a,i))),l=s&&!Q,i+=1,i%y===0&&x.canvasToSVG()},function(){var t=b.loadingDiv,e=+b.loadingShown
tt(),x.canvasToSVG(),h(x,"renderedCanvas"),1===e&&(c(t.style,{transition:"opacity 250ms",opacity:0}),b.loadingShown=!1,setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),b.loadingDiv=b.loadingSpan=null},250)),e&&(b.loadingShown=e-1),x.directTouch=!1,x.options.stickyTracking=!0,delete x.buildKDTree,x.buildKDTree()},b.renderer.forExport?Number.MAX_VALUE:void 0)}}),s.scatter.prototype.cvsMarkerCircle=function(t,e,i,o){t.moveTo(e,i),t.arc(e,i,o,0,2*Math.PI,!1)},s.scatter.prototype.cvsMarkerSquare=function(t,e,i,o){t.moveTo(e,i),t.rect(e-o,i-o,2*o,2*o)},s.scatter.prototype.fill=!0,c(s.area.prototype,{cvsDrawPoint:function(t,e,i,o,n){n&&e!==n.clientX&&(t.moveTo(n.clientX,n.yBottom),t.lineTo(n.clientX,n.plotY),t.lineTo(e,i),t.lineTo(e,o))},fill:!0,fillOpacity:!0,sampling:!0}),c(s.column.prototype,{cvsDrawPoint:function(t,e,i,o){t.rect(e-1,i,1,o-i)},fill:!0,sampling:!0}),a.prototype.getPoint=function(t){var e=t
return!t||t instanceof this.pointClass||(e=(new this.pointClass).init(this,this.options.data[t.i]),e.category=e.x,e.dist=t.dist,e.distX=t.distX,e.plotX=t.plotX,e.plotY=t.plotY),e},g(a.prototype,"searchPoint",function(t){return this.getPoint(t.apply(this,[].slice.call(arguments,1)))})})
